@startuml
[*] --> Created : 使用者 新增核准請求

state Created {
  note right
    資料已寫入 DB
    並推送到 RabbitMQ
  end note
}

Created --> WaitingForApproval : 發送核准通知給 ReviewerA

state WaitingForApproval {
  note right
    等待 ReviewerA 處理
    Queue 設有 TTL & Dead-Letter
  end note
}

WaitingForApproval --> Reminder1 : TTL 到期\nConsumer 拉 DLQ 訊息\n發送催繳提醒給 ReviewerA

state Reminder1 {
  note right
    已發第一封催繳
  end note
}

Reminder1 --> WaitingForApproval : 重新放入 Approve Queue

WaitingForApproval --> Reminder2 : 第二次 TTL 到期\nConsumer 拉 DLQ\n發送催繳+升級通知給 ReviewerB

state Reminder2 {
  note right
    已發第二封催繳
    已通知上級 ReviewerB
  end note
}

Reminder2 --> WaitingForApproval : （可選）重新放回 Approve Queue

WaitingForApproval --> ApprovedByA : ReviewerA 點選「通過」

state ApprovedByA {
  note right
    A 核准，更新 DB 紀錄
  end note
}

ApprovedByA --> Completed : 完成所有後續邏輯

WaitingForApproval --> EscalatedToB : ReviewerA 拒絕或逾時升級

state EscalatedToB {
  note right
    由上級 ReviewerB 處理
  end note
}

EscalatedToB --> ApprovedByB : ReviewerB 點選「通過」

state ApprovedByB {
  note right
    B 核准，更新 DB 紀錄
  end note
}

ApprovedByB --> Completed

state Completed {
  note right
    更新 approval_request.status = approved
    執行檔案存檔、AI 計算、業務邏輯等
  end note
}

Completed --> [*]
@enduml
