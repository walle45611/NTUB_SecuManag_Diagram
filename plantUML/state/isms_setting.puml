@startuml

hide empty description

[*] --> Draft : 使用者點擊「編輯 ISMS 設定」\nGET /api/isms/isms-setting/
state "草稿\n(Draft)" as Draft <<draft>>

Draft --> PendingApproval : 保存設定\nPOST /api/isms/isms-setting/\n→ 暫存 domain 物件含版本資料\n→ publish_create_event
state "待核准\n(Pending Approval)" as PendingApproval <<approval>>

PendingApproval --> Approved : approval_completed
PendingApproval --> Rejected : approval_rejected\n→ Worker 清理相關聯資料
state "被退回\n(Rejected)" as Rejected <<terminal>>
Rejected --> Draft : 再次編輯後重新送審

state "已核准\n(Approved)" as Approved <<approval>>

state "啟用中\n(Active)" as Active <<active>> {
  [*] --> InUse
  state "使用中\n(In-Use)"        as InUse
  state "風險計算中\n(Recalculating)" as Recalculating

  InUse --> Recalculating : 編輯 ISMS-Setting 資料\nPOST /api/isms/isms-setting/update-isms-setting/
  Recalculating --> InUse : 發送核准請求，並回到待核准狀態
}

Approved --> Active : Worker 處理 approval.completed 訊息\n→ 修改資料狀態並進行文件歸檔\n→ UPDATE isms_setting\n→ 觸發 Stored Procedure 重算風險

Active --> Archived : 刪除上版的 embedding 文件，並將當前的 embedding 文件進行封存
state "已封存\n(Archived)" as Archived <<terminal>>
@enduml
