@startuml Role Category Approval Side Effect
  !theme plain
  skinparam sequenceMessageAlign center
  skinparam maxMessageSize 150

  title 角色類別 (Role Category) Approval Side Effect 流程

  participant Consumer as "approval_approved_callback"
  participant ApprovalSvc as "ApprovalService\n(RabbitMQ)"
  participant RoleRepo as "RoleRepository"
  participant Database as "PostgreSQL Database"
  participant DocumentSvc as "DocumentService"
  participant Email as "NotificationService"

  note over Consumer: 從 RabbitMQ 接收到\n"approval.completed.approved"\n消息\nrelated_object_category = "role"

  == 通用處理階段 ==

  Consumer -> ApprovalSvc: handle_side_effects(\napproval, "approved", loop)
  note right: approval_service.py:151

  ApprovalSvc -> ApprovalSvc: _validate_approval(approval)
  note right: 驗證 related_object_category = "role"\n對應到 ApprovalCategory.ROLE

  ApprovalSvc -> ApprovalSvc: _process_signers_for_approval(\napproval, "approved")
  note right: 處理簽核人資訊

  == 角色類別特定處理 ==

  ApprovalSvc -> ApprovalSvc: _handle_approval_side_effects(\napproval, "approved", creator_id, signers, RoleRepo, loop)
  note right: approval_service.py:108-150

  ApprovalSvc -> RoleRepo: handle_approved(\napproval, creator_id, signers, "approved")
  note right: role_repository.py:31-86

  RoleRepo -> RoleRepo: _get_permission_ids_by_role_id(role_id)
  note right: role_repository.py:13-29\n獲取角色相關的權限 ID 列表

  RoleRepo -> Database: SELECT system_get_role_permission_ids_by_role_id(:role_id)
  note right: role_repository.py:17-27\n查詢角色權限關聯

  Database --> RoleRepo: permission_ids: list[UUID]
  note right: 返回權限 ID 陣列

  RoleRepo -> RoleRepo: 準備文件資訊
  note right: document_id = uuid.uuid4()\ndocument_name = f"{approval_name}_{action_type}_{final_status}_四階證明文件"

  RoleRepo -> Database: CALL system_handle_approved_role_approval(\nrole_id, permission_ids, approval_id, action_type,\nfinal_status, signers, document_id, document_name,\nuploadfile_entity_id, creator_id)
  note right: role_repository.py:55-84\n執行角色權限簽核處理

  Database --> RoleRepo: document_id
  note right: 返回生成的文件 ID

  RoleRepo --> ApprovalSvc: document_id

  note over ApprovalSvc: 角色類別不需要風險追蹤\n(跳過 _risk_tracking_logic_service)

  == 文件歸檔階段 ==

  ApprovalSvc -> ApprovalSvc: _document_repo.get_document_archive_ids_by_related_object(\nrelated_object_id, "role")
  note right: approval_service.py:130-135

  ApprovalSvc -> DocumentSvc: archive_document(\ndocument_id, document_archive_ids, "role")
  note right: approval_service.py:137-141

  == 通知與清理階段 ==

  Consumer -> Email: approved_success_notify(\nemail, approval_id)
  note right: approval_approved_callback.py:33-35

  Consumer -> Consumer: queue_service.delete_queue(\napproval_id, loop)
  note right: approval_approved_callback.py:38-39

  Consumer -> Consumer: ch.basic_ack(delivery_tag)
  note right: approval_approved_callback.py:41

  @enduml