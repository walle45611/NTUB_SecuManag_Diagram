@startuml

actor User as "一般使用者"
participant Frontend
participant "Threat/Vuln API" as DomainAPI
participant "PendingOperations\nManager" as POM
participant "Approval API" as ApprovalAPI
participant "RabbitMQ" as MQ
participant "Approval Worker" as Worker
database Database

User -> Frontend: 送出威脅/弱點資料
Frontend -> DomainAPI: POST /api/isms/(threat|vulnerability)/
DomainAPI -> POM: publish_create_event(threat/vuln 暫存資料)
DomainAPI --> Frontend: 成功回應 (僅暫存事件)
Frontend -> ApprovalAPI: POST /api/system/approval/
ApprovalAPI -> POM: consume_event_and_get_domain(threat/vuln 暫存資料)
ApprovalAPI -> Database: INSERT asset 暫存資料 (is_current = false)
ApprovalAPI -> Database: INSERT approval (final_status = pending)
ApprovalAPI -> MQ: 建立 pending_approval_queue_{approval_id}
ApprovalAPI --> Frontend: 顯示簽核已送出

@enduml
