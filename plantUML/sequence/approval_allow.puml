@startuml

title 核准允許流程 (Approval Allow Process)

actor ReviewerA as "核准者A"
actor ReviewerB as "核准者B"
participant Frontend as "前端介面"
participant Backend as "後端服務"
participant Database as "資料庫"
participant NotificationService as "通知服務"

== 核准操作階段 ==
ReviewerA ->> Frontend: 點選「通過」
activate Frontend

Frontend ->> Backend: POST /api/system/approval/{approval_id}/user/{user_id}/approved
activate Backend

Backend ->> Database: 驗證簽核請求狀態
activate Database
Database -->> Backend: 返回驗證結果
deactivate Database

Backend ->> Database: 更新核准狀態與簽核人資訊
activate Database

== 判斷後續流程 ==
Backend ->> Database: 查詢是否還有待審核者
Database -->> Backend: 返回待審核者列表

alt 還有下一位審核者
    deactivate Database
    Backend ->> NotificationService: 發布核准通知到佇列
    activate NotificationService
    NotificationService -->> ReviewerB: 通知下一位審核者
    deactivate NotificationService

    Backend -->> Frontend: 成功回應 {"success": true, "message": "簽核確認成功"}
    Frontend -->> ReviewerA: 彈出綠色成功 alert「簽核確認成功」

else 全部審核完成
    Backend ->> Database: 更新請求狀態為已核准
    deactivate Database

    Backend ->> NotificationService: 發布核准完成通知到佇列
    activate NotificationService
    NotificationService -->> ReviewerA: 通知申請者簽核通過
    deactivate NotificationService

    Backend -->> Frontend: 成功回應 {"success": true, "message": "簽核確認成功"}
    Frontend -->> ReviewerA: 彈出綠色成功 alert「簽核確認成功」
end

deactivate Backend
deactivate Frontend

@enduml