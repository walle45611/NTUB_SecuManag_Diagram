@startuml

actor ReviewerA as "核准者A"
actor Requester as "申請者"
participant Frontend
participant Backend
participant Database
participant RabbitMQ
actor ReviewerB as "核准者B"

== 核准操作階段 ==
ReviewerA ->> Frontend: 點選「通過」
activate Frontend

Frontend ->> Backend: POST /api/system/approval/{approval_id}/user/{user_id}/approved
activate Backend

Backend ->> Database: 驗證簽核請求狀態
activate Database
Database -->> Backend: 返回驗證結果
deactivate Database

Backend ->> Database: 更新核准狀態與簽核人資訊
activate Database

== 判斷後續流程 ==
Backend ->> Database: 查詢是否還有待審核者
Database -->> Backend: 返回待審核者列表

alt 還有下一位審核者
    deactivate Database
    Backend ->> RabbitMQ: 發布簽核到佇列
    Backend ->> ReviewerB: 通知下一位審核者
    Backend -->> Frontend: 成功回應 {"success": true, "message": "簽核確認成功"}
    Frontend -->> ReviewerA: 彈出綠色成功 alert「簽核確認成功」

else 全部審核完成
    Backend ->> Database: 更新請求狀態為已核准
    deactivate Database
    Backend -->> Requester: 通知申請者簽核通過
    Backend -->> Frontend: 成功回應 {"success": true, "message": "簽核確認成功"}
    Frontend -->> ReviewerA: 彈出綠色成功 alert「簽核確認成功」
end

deactivate Backend
deactivate Frontend

@enduml